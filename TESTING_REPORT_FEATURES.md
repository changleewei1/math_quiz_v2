# 報表系統新功能測試指南

本文檔說明如何測試新增的三個功能。

## 前置準備

1. **確保資料庫已更新**
   - 執行 `supabase/add_classes.sql`（如果尚未執行）

2. **確保環境變數已設定**
   - `PARENT_LINK_SECRET` 或 `REPORT_TOKEN_SECRET` 或 `ADMIN_COOKIE_SECRET`（至少32字元）
   - `APP_PUBLIC_BASE_URL`（例如 `http://localhost:3000` 或正式網域）

3. **準備測試資料**
   - 至少建立一個班級
   - 至少建立2-3個學生帳號
   - 將學生加入班級
   - 讓至少2個學生完成診斷測驗（其中一個在30天內，一個在30天前）

## 測試流程

### 測試 1：時間範圍切換

1. **登入後台**
   - 訪問 `/admin/login`
   - 輸入管理員密碼

2. **開啟班級總覽**
   - 訪問 `/teacher/class/[classId]/overview`
   - 確認頁面正常載入

3. **切換時間範圍**
   - 點擊「最近一次」按鈕（預設）
   - 確認圖表和表格顯示所有學生的最新診斷結果
   - 點擊「最近30天」按鈕
   - 確認：
     - 圖表和表格更新
     - 只顯示最近30天內有測驗的學生
     - 30天前測驗的學生標記為「未測」
     - 顯示「統計範圍：最近30天」

4. **驗證資料正確性**
   - 切換範圍後，確認班級平均正確率正確計算
   - 確認弱點題型統計正確

### 測試 2：補救名單

1. **開啟補救名單功能**
   - 在班級總覽頁面點擊「補救名單」按鈕
   - 確認補救名單區塊顯示

2. **選擇題型**
   - 確認預設已勾選 Top 3 弱點題型
   - 取消勾選某些題型
   - 勾選其他題型
   - 確認選擇狀態正確

3. **產生補救名單**
   - 點擊「產生補救名單」按鈕
   - 確認：
     - 顯示補救名單列表
     - 只包含在選定題型中 `wrong >= 2` 的學生
     - 每位學生顯示：
       - 學生姓名
       - 需要補救的題型（以 code 串起來）
       - 總正確率
       - 最新測驗日期
       - 「開啟個別報告」連結

4. **匯出 CSV**
   - 點擊「匯出 CSV」按鈕
   - 確認：
     - 下載 CSV 檔案
     - 檔名格式：`補救名單_{className}_{range}_{YYYYMMDD}.csv`
     - CSV 內容包含所有必要欄位
     - 中文內容正確顯示（使用 UTF-8 BOM）

5. **切換時間範圍後測試**
   - 切換到「最近30天」
   - 重新產生補救名單
   - 確認補救名單依據新的時間範圍

### 測試 3：一鍵派發家長連結

#### 3.1 單一學生連結

1. **產生單一連結**
   - 在學生清單表格中找到有測驗記錄的學生
   - 點擊該學生列的「產生家長連結」按鈕
   - 確認：
     - 顯示「產生中...」
     - 產生後顯示連結區塊
     - 連結格式：`/report/student/[studentId]?token=...`

2. **複製連結**
   - 點擊「複製連結」按鈕
   - 確認連結已複製到剪貼簿
   - 貼上到文字編輯器驗證格式正確

3. **測試連結有效性**
   - 在無痕視窗中開啟連結
   - 確認：
     - 顯示學生的弱點分析報告
     - 報告內容正確
     - 顯示所有圖表和統計資料

#### 3.2 批次產生連結

1. **批次產生**
   - 點擊「家長連結」按鈕
   - 點擊「批次產生本班全部學生連結」
   - 確認：
     - 顯示所有學生的連結列表
     - 每位學生顯示：
       - 學生姓名
       - 完整連結 URL
       - 到期時間（7天後）
     - 每個連結都有「複製」按鈕

2. **測試個別連結**
   - 複製其中一個連結
   - 在無痕視窗中開啟
   - 確認報告正確顯示

3. **匯出 CSV**
   - 點擊「匯出 CSV」按鈕
   - 確認：
     - 下載 CSV 檔案
     - 檔名格式：`家長連結_{className}_{YYYYMMDD}.csv`
     - CSV 包含：學生ID、學生姓名、家長連結、到期時間
     - 所有連結都是有效的

4. **測試 token 過期**
   - 手動修改一個 token（或等待7天）
   - 嘗試開啟連結
   - 確認顯示「連結已失效，請向老師索取最新連結」

5. **切換時間範圍後測試**
   - 切換到「最近30天」
   - 批次產生連結
   - 確認只產生該範圍內有測驗記錄的學生連結

## 錯誤處理測試

1. **沒有測驗記錄的學生**
   - 確認「未測」學生不顯示「產生家長連結」按鈕
   - 確認批次產生時仍會產生連結（但報告頁面會顯示錯誤）

2. **無效的 classId**
   - 嘗試訪問不存在的班級總覽
   - 確認顯示適當的錯誤訊息

3. **未勾選題型就產生補救名單**
   - 取消所有題型勾選
   - 點擊「產生補救名單」
   - 確認顯示「請至少選擇一個題型」提示

4. **無效的 token**
   - 手動修改 URL 中的 token
   - 確認顯示「無效的 token」錯誤

## 效能測試

1. **大量學生測試**
   - 建立50+學生
   - 測試批次產生連結的效能
   - 測試補救名單產生的效能

2. **大量測驗記錄測試**
   - 為每個學生建立多筆測驗記錄
   - 測試時間範圍切換的效能
   - 確認查詢速度可接受

## 預期結果

所有功能應：
- ✅ 正確顯示繁體中文
- ✅ 在手機上正常顯示（響應式設計）
- ✅ 正確處理錯誤情況
- ✅ 載入速度合理（< 3秒）
- ✅ CSV 匯出正確（UTF-8 BOM，中文顯示正確）
- ✅ Token 驗證安全性正確

## 常見問題

### Q: 補救名單為空
**A:** 確認選定的題型中是否有學生 `wrong >= 2`。可以檢查班級總覽的弱點統計。

### Q: 批次產生連結時某些學生沒有連結
**A:** 這是正常的。系統會為所有班級成員產生連結，即使他們沒有測驗記錄。沒有測驗記錄的學生，連結會導向到錯誤頁面。

### Q: CSV 中文顯示亂碼
**A:** 確認使用 UTF-8 BOM 編碼。Excel 開啟時應能正確顯示。如果仍有問題，使用文字編輯器開啟驗證。

### Q: Token 驗證失敗
**A:** 確認環境變數 `PARENT_LINK_SECRET`、`REPORT_TOKEN_SECRET` 或 `ADMIN_COOKIE_SECRET` 已正確設定（至少32字元）。

